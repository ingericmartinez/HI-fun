<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Alquimia EstratÃ©gica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .element-item {
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 2px solid transparent;
            position: relative; /* Needed for the count badge */
        }
        .element-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .selected-element {
            border-color: #60a5fa; /* border-blue-400 */
            transform: scale(1.05);
            box-shadow: 0 0 20px #60a5fa;
        }
        /* Style for the item count badge */
        .item-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            border-radius: 9999px;
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.5s ease-in-out forwards; }
        @keyframes success-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .success-pop { animation: success-pop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .sidebar-scroll::-webkit-scrollbar { width: 8px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: #2d3748; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <div class="w-full max-w-5xl h-[90vh] bg-gray-800 rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden border border-gray-700">

        <!-- Panel de Elementos -->
        <aside class="w-full md:w-1/3 lg:w-1/4 bg-gray-800/50 p-6 border-b md:border-b-0 md:border-r border-gray-700 flex flex-col">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold">Tu Inventario</h2>
            </div>
            <div class="flex justify-between items-center mb-4">
                <p class="text-lg">Descubiertos: <span id="discovered-count">0</span>/<span id="total-count">0</span></p>
                <button id="reset-button" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">Reiniciar</button>
            </div>
            <div id="elements-list" class="flex-grow sidebar-scroll overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-3 gap-4 pr-2"></div>
        </aside>

        <!-- Ãrea de Juego -->
        <main class="flex-grow p-6 flex flex-col items-center justify-center relative">
            <h1 class="text-3xl font-bold text-center mb-4">Laboratorio de Alquimia</h1>
            <p id="instruction-text" class="text-gray-400 mb-6 text-center">Haz clic en un elemento para empezar...</p>
            <div id="combination-area" class="w-full h-64 md:h-80 bg-gray-900/50 rounded-2xl border-2 border-dashed border-gray-600 flex items-center justify-center gap-4 p-4"></div>
            <div id="message-box" class="absolute bottom-8 px-6 py-3 rounded-lg text-lg font-semibold transition-all duration-500 opacity-0 -translate-y-10"></div>
        </main>
    </div>

    <script>
        // --- BASE DE DATOS DEL JUEGO ---
        const elementsData = {
            'agua': { name: 'Agua', emoji: 'ðŸ’§' }, 'fuego': { name: 'Fuego', emoji: 'ðŸ”¥' }, 'tierra': { name: 'Tierra', emoji: 'ðŸŒŽ' },
            'aire': { name: 'Aire', emoji: 'ðŸ’¨' }, 'huevo': { name: 'Huevo', emoji: 'ðŸ¥š' }, 'hombre': { name: 'Hombre', emoji: 'ðŸ‘¨' },
            'vida': { name: 'Vida', emoji: 'ðŸ§¬' },
        };
        const recipes = {
            'fuego,huevo': { id: 'huevo_frito', name: 'Huevo Frito', emoji: 'ðŸ³' }, 'agua,fuego': { id: 'vapor', name: 'Vapor', emoji: 'â™¨ï¸' },
            'agua,tierra': { id: 'lodo', name: 'Lodo', emoji: 'ðŸŸ¤' }, 'fuego,tierra': { id: 'lava', name: 'Lava', emoji: 'ðŸŒ‹' },
            'tierra,vida': { id: 'planta', name: 'Planta', emoji: 'ðŸŒ±' }, 'agua,vida': { id: 'plancton', name: 'Plancton', emoji: 'ðŸ¦ ' },
            'aire,fuego': { id: 'energia', name: 'EnergÃ­a', emoji: 'âš¡' }, 'aire,lava': { id: 'piedra', name: 'Piedra', emoji: 'ðŸª¨' },
            'aire,vapor': { id: 'nube', name: 'Nube', emoji: 'â˜ï¸' }, 'lodo,planta': { id: 'pantano', name: 'Pantano', emoji: 'ðŸŠ' },
            'plancton,vida': { id: 'pez', name: 'Pez', emoji: 'ðŸŸ' }, 'planta,tierra': { id: 'arbol', name: 'Ãrbol', emoji: 'ðŸŒ³' },
            'fuego,piedra': { id: 'metal', name: 'Metal', emoji: 'ðŸ”©' }, 'energia,nube': { id: 'rayo', name: 'Rayo', emoji: 'ðŸŒ©ï¸' },
            'arbol,arbol': { id: 'bosque', name: 'Bosque', emoji: 'ðŸŒ²' }, 'hombre,pez': { id: 'sirena', name: 'Sirena', emoji: 'ðŸ§œâ€â™€ï¸' },
            'hombre,metal': { id: 'herramienta', name: 'Herramienta', emoji: 'ðŸ› ï¸' }, 'bosque,vida': { id: 'animal', name: 'Animal', emoji: 'ðŸ˜' },
            'metal,rayo': { id: 'electricidad', name: 'Electricidad', emoji: 'ðŸ’¡' }, 'arbol,herramienta': { id: 'madera', name: 'Madera', emoji: 'ðŸªµ' },
            'animal,tierra': { id: 'ganado', name: 'Ganado', emoji: 'ðŸ„' }, 'herramienta,piedra': { id: 'escultura', name: 'Escultura', emoji: 'ðŸ—¿' },
            'herramienta,madera': { id: 'rueda', name: 'Rueda', emoji: 'ðŸ›ž' }, 'fuego,ganado': { id: 'carne', name: 'Carne', emoji: 'ðŸ¥©' },
            'madera,madera': { id: 'casa', name: 'Casa', emoji: 'ðŸ ' }, 'metal,rueda': { id: 'coche', name: 'Coche', emoji: 'ðŸš—' },
            'casa,hombre': { id: 'familia', name: 'Familia', emoji: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦' }, 'herramienta,planta': { id: 'harina', name: 'Harina', emoji: 'ðŸŒ¾' },
            'agua,harina': { id: 'masa', name: 'Masa', emoji: 'ðŸª' }, 'fuego,masa': { id: 'pan', name: 'Pan', emoji: 'ðŸž' },
            'carne,pan': { id: 'sandwich', name: 'SÃ¡ndwich', emoji: 'ðŸ¥ª' },
        };

        // NEW: Inventory system to track item counts
        let playerInventory = {};
        let firstSelectedId = null;

        const elementsList = document.getElementById('elements-list');
        const combinationArea = document.getElementById('combination-area');
        const instructionText = document.getElementById('instruction-text');
        const discoveredCountEl = document.getElementById('discovered-count');
        const totalCountEl = document.getElementById('total-count');
        const resetButton = document.getElementById('reset-button');
        const messageBox = document.getElementById('message-box');

        function getRecipeKey(id1, id2) { return [id1, id2].sort().join(','); }

        function handleCombination(id1, id2) {
            // Check if player has the ingredients
            const hasIngredients = (id1 === id2 && playerInventory[id1] >= 2) || (id1 !== id2 && playerInventory[id1] >= 1 && playerInventory[id2] >= 1);
            if (!hasIngredients) {
                showMessage("Â¡No tienes los elementos necesarios!", 'bg-yellow-500');
                resetSelection();
                return;
            }
            
            const recipeKey = getRecipeKey(id1, id2);
            const result = recipes[recipeKey];

            combinationArea.innerHTML = '';
            
            if (result) {
                // Consume ingredients
                playerInventory[id1]--;
                playerInventory[id2]--;
                
                // Add result
                playerInventory[result.id] = (playerInventory[result.id] || 0) + 1;

                const resultEl = createVisualElement(result.id, result);
                resultEl.classList.add('success-pop');
                combinationArea.appendChild(resultEl);
                
                const isNewDiscovery = !Object.keys(playerInventory).includes(result.id) || playerInventory[result.id] === 1;
                if (isNewDiscovery) {
                    showMessage(`Â¡Nuevo Descubrimiento: ${result.name}!`, 'bg-green-500');
                } else {
                    showMessage(`Creaste ${result.name} de nuevo.`, 'bg-blue-500');
                }
                saveState();
                renderSideBar();
                setTimeout(() => { combinationArea.innerHTML = ''; }, 2000);
            } else {
                const allElements = getAllElements();
                combinationArea.appendChild(createVisualElement(id1, allElements[id1]));
                combinationArea.appendChild(createVisualElement(id2, allElements[id2]));
                
                combinationArea.classList.add('shake');
                showMessage("Eso no se puede combinar...", 'bg-red-500');
                setTimeout(() => {
                    combinationArea.innerHTML = '';
                    combinationArea.classList.remove('shake');
                }, 1200);
            }
        }

        function resetSelection() {
            firstSelectedId = null;
            document.querySelectorAll('.selected-element').forEach(el => el.classList.remove('selected-element'));
            combinationArea.innerHTML = '';
            instructionText.textContent = "Haz clic en un elemento para empezar...";
        }

        function handleElementClick(e) {
            const clickedEl = e.target.closest('.element-item');
            if (!clickedEl) return;

            const clickedId = clickedEl.dataset.id;
            
            if(playerInventory[clickedId] < 1) {
                showMessage("Se te acabaron los " + getAllElements()[clickedId].name, 'bg-yellow-500');
                return;
            }

            if (!firstSelectedId) {
                firstSelectedId = clickedId;
                clickedEl.classList.add('selected-element');
                combinationArea.innerHTML = '';
                combinationArea.appendChild(createVisualElement(clickedId, getAllElements()[clickedId]));
                instructionText.textContent = "Ahora haz clic en otro elemento para combinarlo...";
            } else if (firstSelectedId === clickedId) {
                resetSelection();
            } else {
                handleCombination(firstSelectedId, clickedId);
                resetSelection();
            }
        }

        elementsList.addEventListener('click', handleElementClick);

        function getAllElements() {
            return { ...elementsData, ...Object.values(recipes).reduce((acc, curr) => ({ ...acc, [curr.id]: curr }), {}) };
        }

        function showMessage(text, bgColorClass) {
            messageBox.textContent = text;
            messageBox.className = `absolute bottom-8 px-6 py-3 rounded-lg text-lg font-semibold transition-all duration-500 opacity-100 translate-y-0 ${bgColorClass}`;
            setTimeout(() => { messageBox.className = messageBox.className.replace('opacity-100 translate-y-0', 'opacity-0 -translate-y-10'); }, 2500);
        }

        function createVisualElement(id, data, count = null) {
            const el = document.createElement('div');
            el.dataset.id = id;
            el.className = 'element-item flex flex-col items-center justify-center p-2 bg-gray-700 rounded-lg aspect-square w-full h-full fade-in';
            el.innerHTML = `<span class="text-4xl">${data.emoji}</span><span class="text-xs text-center mt-1">${data.name}</span>`;
            if (count !== null && count !== Infinity) {
                const countBadge = document.createElement('span');
                countBadge.className = 'item-count';
                countBadge.textContent = count;
                el.appendChild(countBadge);
            }
            return el;
        }

        function renderSideBar() {
            const allElements = getAllElements();
            const previouslySelected = firstSelectedId;
            elementsList.innerHTML = '';
            
            const discoveredIds = Object.keys(playerInventory).filter(id => playerInventory[id] > 0);
            const allAvailableIds = [...new Set([...Object.keys(elementsData), ...discoveredIds])];

            allAvailableIds.sort((a, b) => allElements[a].name.localeCompare(allElements[b].name)).forEach(id => {
                const data = allElements[id];
                if (data) {
                    const el = createVisualElement(id, data, playerInventory[id]);
                    if (id === previouslySelected) {
                        el.classList.add('selected-element');
                    }
                    elementsList.appendChild(el);
                }
            });
            updateCounts();
        }

        function updateCounts() {
            totalCountEl.textContent = Object.keys(recipes).length;
            // Count discovered as any created element with a count > 0
            const discoveredCount = Object.keys(playerInventory).filter(id => !elementsData[id] && playerInventory[id] > 0).length;
            discoveredCountEl.textContent = discoveredCount;
        }

        function saveState() { localStorage.setItem('alchemyGameSave_v9_inventory', JSON.stringify(playerInventory)); }

        function loadState() {
            const saved = localStorage.getItem('alchemyGameSave_v9_inventory');
            playerInventory = saved ? JSON.parse(saved) : {};
            // Ensure base elements are always available and infinite
            for (const baseId in elementsData) {
                playerInventory[baseId] = Infinity;
            }
        }
        
        function resetGame() {
            if (confirm('Â¿EstÃ¡s seguro de que quieres reiniciar tu progreso?')) {
                playerInventory = {};
                saveState();
                loadState(); // This will re-add the infinite base elements
                resetSelection();
                renderSideBar();
                showMessage("Juego reiniciado.", 'bg-green-500');
            }
        }
        resetButton.addEventListener('click', resetGame);
        
        function init() {
            loadState();
            renderSideBar();
        }
        init();
    </script>
</body>
</html>

